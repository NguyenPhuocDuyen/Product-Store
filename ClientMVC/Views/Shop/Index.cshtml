<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Include toastr CSS and JS files -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

@model Utility.PaginatedList<Models.Product>
@{
    string searchContent = ViewBag.searchContent;
    int min = ViewBag.min;
    int max = ViewBag.max;
    int sort_order = ViewBag.sort_order;
    int TotalProduct = ViewBag.TotalProduct;

    List<Models.Category> categories = ViewBag.Categories;
}

<!-- Breadcrumb Section Begin -->
@*<section class="breadcrumb-option">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <div class="breadcrumb__text">
                    <h4>Shop</h4>
                    <div class="breadcrumb__links">
                        <a href="./index.html">Home</a>
                        <span>Shop</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>*@
<!-- Breadcrumb Section End -->
<hr />
<!-- Shop Section Begin -->
<section class="shop spad">
    <div class="container">
        <div class="row">
            <div class="col-lg-3">
                <div class="shop__sidebar">
                    <div class="shop__sidebar__search">
                        <form asp-action="Index">
                            <input type="text" name="searchContent" value="@searchContent" placeholder="Search...">
                            <button type="submit"><span class="icon_search"></span></button>
                        </form>
                    </div>
                    <div class="shop__sidebar__accordion">
                        <div class="accordion" id="accordionExample">
                            <div class="card">
                                <div class="card-heading">
                                    <a data-toggle="collapse" data-target="#collapseOne">Categories</a>
                                </div>
                                <div id="collapseOne" class="collapse show" data-parent="#accordionExample">
                                    <div class="card-body">
                                        <div class="shop__sidebar__categories">
                                            <ul class="nice-scroll">
                                                @foreach (var item in categories)
                                                {
                                                    <li><a asp-action="Index" asp-route-searchContent="@item.Description">@item.Description (@item.Products.Count())</a></li>
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-heading">
                                    <a data-toggle="collapse" data-target="#collapseTwo">Filter Price</a>
                                </div>
                                <div id="collapseTwo" class="collapse show" data-parent="#accordionExample">
                                    <div class="card-body">
                                        <div class="shop__sidebar__price">
                                            <ul>
                                                @{
                                                    int minPrice = 0;
                                                    int maxPrice = 1000000;

                                                    for (int i = 0; i < 5; i++)
                                                    {
                                                        string priceDisplay = $"{minPrice/1000} - {maxPrice / 1000}";
                                                        if (i == 4)
                                                        {
                                                            maxPrice = int.MaxValue;    
                                                            priceDisplay = $"{minPrice/1000}+";
                                                        }

                                                        var parms = new Dictionary<string, string>
                                                        {
                                                            { "searchContent", searchContent },
                                                            { "min", minPrice.ToString() },
                                                            { "max", maxPrice.ToString() },
                                                            { "sort_order", sort_order.ToString() },
                                                        };
                                                        <li><a asp-action="Index" asp-all-route-data="@parms">@priceDisplay  K VND</a></li>

                                                        minPrice = maxPrice;
                                                        maxPrice += 1000000 * (i + 1);
                                                    }
                                                }
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="shop__product__option">
                    <div class="row">
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="shop__product__option__left">
                                <p>Showing 1–12 of @Model.TotalItem results</p>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-6 col-sm-6">
                            <div class="shop__product__option__right">
                                <p>Sort by Price:</p>
                                <select id="sort-order" onchange="sortProductByPrice()">
                                    <option value="1">Low To High</option>
                                    <option value="2">High To Low</option>
                                </select>

                                @{
                                    var parms2 = new Dictionary<string, string>
                                        {
                                            { "searchContent", searchContent },
                                            { "min", min.ToString() },
                                            { "max", max.ToString() },
                                            { "sort_order", sort_order.ToString() },
                                        };
                                }
                                <a id="sort-link" class="btn btn-primary" asp-action="Index" asp-all-route-data="@parms2">Sort</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" id="product-list">
                    @foreach(var item in Model)
                    {
                        <div class="col-lg-4 col-md-6 col-sm-6">
                            <div class="product__item sale">
                                <div class="product__item__pic set-bg" data-setbg="/img/product/product-1.jpg">
                                    <span class="label">Sale</span>
                                    <ul class="product__hover">
                                        <li><a href="#"><img src="~/img/icon/heart.png" alt=""></a></li>
                                        <li><a href="#"><img src="~/img/icon/compare.png" alt=""> <span>Compare</span></a>
                                        </li>
                                        <li><a href="@Url.Action("ProductDetail", "Shop", new { id = item.Id })"><img src="~/img/icon/search.png" alt=""></a></li>
                                    </ul>
                                </div>
                                <div class="product__item__text">
                                    <h6>@item.Title</h6>
                                    <a style="cursor: pointer" id="addCart" class="add-cart" data-id="@item.Id">+ Add To Cart</a>
                                    <div class="rating">
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star"></i>
                                        <i class="fa fa-star-o"></i>
                                    </div>
                                    <h5>$@item.RecentPrice</h5>
                                    <div class="product__color__select">
                                        <label for="pc-7">
                                            <input type="radio" id="pc-7">
                                        </label>
                                        <label class="active black" for="pc-8">
                                            <input type="radio" id="pc-8">
                                        </label>
                                        <label class="grey" for="pc-9">
                                            <input type="radio" id="pc-9">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="product__pagination">
                            @{
                                var smallPage = (Model.PageIndex-2)>0 ? Model.PageIndex-2 : 1;
                                int bigPage = (Model.PageIndex+2)<=Model.TotalPages ? Model.PageIndex+2 : Model.TotalPages;

                                for (var j = smallPage; j<=bigPage; j++)
                                {
                                    var parms3 = new Dictionary<string, string>
                                        {
                                            { "searchContent", searchContent },
                                            { "min", min.ToString() },
                                            { "max", max.ToString() },
                                            { "sort_order", sort_order.ToString() },
                                            { "pageIndex", j.ToString() },
                                        };
                                    string isActive = j == Model.PageIndex ? "active" : "";
                                    <a class="@isActive" asp-action="Index" asp-all-route-data="@parms3">@j</a>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<script>
    const selectElement = document.getElementById('sort-order');
    const sortLink = document.getElementById('sort-link');
    document.getElementById("sort-order").value = @sort_order.ToString();

    function sortProductByPrice() {
        const selectedValue = selectElement.value;
        const newHref = `/Shop?searchContent=@searchContent&min=@min&max=@max&sort_order=${selectedValue}`;
        sortLink.href = newHref;
    }

</script>

<script>
    $(document).ready(function () {
        var id = $(this).closest('.product__item').data('id');
        var buttons = document.querySelectorAll('#addCart');
        buttons.forEach(function (button) {
            button.addEventListener('click', function () {
                var productId = this.dataset.id;
                $.ajax({
                    url: 'https://localhost:44362/api/Carts/AddProductToCart',
                    type: 'POST',
                    data: JSON.stringify({ UserId: '1', ProductId: productId }),
                    contentType: 'application/json; charset=utf-8',
                    dataType: 'json',
                    success: function (data) {
                        console.log("success", productId);
                        toastr.success('Product added to cart successfully!');
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('Error: ' + textStatus + ' - ' + errorThrown);
                        toastr.error('Error occurred while adding product to cart!');
                    }
                });
            });
        });

    });
</script>
<!-- Shop Section End -->
@*<script src="~/js/search.js"></script>*@
